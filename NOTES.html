<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>One or two levels in QFeatures (closed) • QFeatures</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script>




<meta property="og:title" content="One or two levels in QFeatures (closed)" />
<meta property="og:image" content="/logo.png" />






<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  

  

  </head>

  <body data-spy="scroll" data-target="#toc">
    

    <div class="container template-title-body">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">QFeatures</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="articles/QFeatures.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="articles/Processing.html">Processing quantitative proteomics data with QFeatures</a>
    </li>
    <li>
      <a href="articles/Visualization.html">Data visualization from a QFeatures object</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/RforMassSpectrometry/QFeatures/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>One or two levels in QFeatures (closed)</h1>
    </div>


<div id="one-or-two-levels-in-qfeatures-closed" class="section level1">

<p>One or two assay levels could be considered in QFeatures:</p>
<ul>
<li><p>one level: each SE contains only a single assay, and when an SE is processed (log-transformed, normalised, …) in a way that its dimensions stay the same, a new SE is created and added to the QFeatures object.</p></li>
<li><p>two level: SEs can contain multiple assays, and when an SE is processed (log-transformed, normalised, …) in a way that its dimensions stay the same, a new assay is added to that SE.</p></li>
</ul>
<p>This <a href="https://stat.ethz.ch/pipermail/bioc-devel/2020-January/016096.html" class="external-link">question</a> on the bioc-devel list ask for advice on SE processing, and whether a new SE or new assay in the original SE should be preferred. While the letter is arguably more elegant, and is also used in SingleAssayExperiment pipelines, it doesn’t seem to be the case when using SummarizedExperiments.</p>
<p>As for features (or <a href="https://github.com/waldronlab/MultiAssayExperiment/issues/266" class="external-link">MultiAssayExperiments in general</a>), the two-level approach isn’t readily available out-of-the-box, and would require additional developments:</p>
<ul>
<li><p>Every function that operates on an SE of a QFeatures object would need to allow the user to specify which assay to use (and/or by default use the latest one).</p></li>
<li><p>The <code>show,QFeatures</code> method would need to display the number/names of the assays in each SE to make these two levels explicit.</p></li>
</ul>
<p>Despite the elegant of the two-level option, it seems that the additional development isn’t warranted at this time.</p>
<p>The <a href="https://github.com/rformassspectrometry/QFeatures/issues/37" class="external-link"><code>updateAssay</code> function</a> was originally intended for the two-level approach, i.e. to add an assay to an SE. This is not considered anymore (for now, at least).</p>
<p>There is one exception though. When aggregating features with <code><a href="reference/QFeatures-aggregate.html">aggregateFeatures()</a></code>, a second assay is added, named <code>aggcounts</code> that counts the number of features that were aggregate for each sample and each low-level features.</p>
</div>
<div id="how-to-add-new-assays" class="section level1">
<h1 class="hasAnchor">
<a href="#how-to-add-new-assays" class="anchor" aria-hidden="true"></a>How to add new assays</h1>
<ol style="list-style-type: decimal">
<li><p>Through aggregation with <code>aggregateFeatures</code>.</p></li>
<li><p>Processing an SE.</p></li>
</ol>
<p>This can/could be done explicitly with <code>addAssay</code></p>
<pre><code>addAssay(cptac, logTransform(cptac[["peptides"]]), name = "peptides_log")
addAssay(cptac, logTransform(cptac[[1]]), name = "peptides_log")</code></pre>
<p>or implicitly</p>
<pre><code>logTransform(cptac, "peptides", name = "peptides_log")
logTransform(cptac, 1, name = "peptides_log")</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Joining SEs (for example multiple TMT batches) (TODO)</li>
</ol>
<pre><code>joinAssays(QFeatures, c("pep_batch1", "pep_batch2", "pep_batch3"), name = "peptides")
joinAssays(QFeatures, c(1, 2, 3), name = "peptides")</code></pre>
<p>See below.</p>
</div>
<div id="qfeatures-api" class="section level1">
<h1 class="hasAnchor">
<a href="#qfeatures-api" class="anchor" aria-hidden="true"></a>QFeatures API</h1>
<div id="processing-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#processing-functions" class="anchor" aria-hidden="true"></a>Processing functions</h3>
<ul>
<li><p>A processing function that acts on a Feature’s assay (typically a <code>SummarizedExperiment</code> or a <code>SingleCellExperiment</code>) such as <code>process(object)</code>, returns a new object of the same type.</p></li>
<li><p>A processing function such <code>process(object, i)</code>, that acts on a Feautre object takes a second argument <code>i</code>, that can be a vector of indices or names, returns a new object of class QFeatures with its assay(s) <code>i</code> modified according to <code>process(object[[i]])</code>.</p></li>
<li><p>The argument <code>i</code> mustn’t be missing, i.e. one shouldn’t (at least in general) permit to (blindly) apply some processing on all assays.</p></li>
</ul>
</div>
<div id="assays" class="section level3">
<h3 class="hasAnchor">
<a href="#assays" class="anchor" aria-hidden="true"></a>Assays</h3>
<ul>
<li>Assays should have unique rownames (even though this isn’t required for SEs). If they aren’t, only the first occurence of the name is kept:</li>
</ul>
<pre><code>hlpsms &lt;- hlpsms[1:5000, ] ## faster

ft1 &lt;- readQFeatures(hlpsms, ecol = 1:10, name = "psms", fname = "Sequence")
sum(rownames(ft1[[1]]) == "ANLPQSFQVDTSk")
ft1 &lt;- aggregateFeatures(ft1, "psms", fcol = "Sequence",
                         name = "peptides", fun = colSums)
sapply(rownames(ft1), anyDuplicated)
ft1

## subsetting still works
ft2 &lt;- subsetByFeature(ft1, "ANLPQSFQVDTSk")
ft2</code></pre>
<p>The underlying reason why this fails is due to matrix subsetting by name when these names aren’t unique.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="va">m</span>
<span class="va">m</span><span class="op">[</span><span class="st">"a"</span>, <span class="op">]</span></code></pre></div>
<p>And of course, this affects SEs …</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu">SummarizedExperiment</span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="fu">assay</span><span class="op">(</span><span class="va">se</span><span class="op">[</span><span class="st">"a"</span>, <span class="op">]</span><span class="op">)</span></code></pre></div>
<p>… and MultiAssayExperiments.</p>
<p>Note that in the example above, <code>"ANLPQSFQVDTSk"</code> is present in both the <code>psms</code> and <code>peptides</code> assays, and the</p>
<pre><code>for (k in setdiff(all_assays_names, leaf_assay_name)) { ... }</code></pre>
<p>loop in <code>.subsetByFeature</code> isn’t executed at all. This will need to be investigated. But the behaviour above can be reproduced even when that’s not the case. See</p>
<pre><code>hlpsms$Sequence2 &lt;- paste0(hlpsms$Sequence, "2")
ft1 &lt;- readQFeatures(hlpsms, ecol = 1:10, name = "psms", fname = "Sequence2")
...</code></pre>
<p>This could be <strong>fixed</strong> by switching to indices:</p>
<pre><code>&gt; (i &lt;- which(rownames(m) == "a"))
[1] 1 2
&gt; m[i, ]
  A B
a 1 6
a 2 7
&gt; se[i, ]
class: SummarizedExperiment
dim: 2 2
metadata(0):
assays(1): ''
rownames(2): a a
rowData names(0):
colnames(2): A B
colData names(0):</code></pre>
<p>See issue #91.</p>
</div>
</div>
<div id="assay-links" class="section level1">
<h1 class="hasAnchor">
<a href="#assay-links" class="anchor" aria-hidden="true"></a>Assay links</h1>
<p>Currently, we have</p>
<ul>
<li><p>Assay links produces by <code>aggregateFeatures</code> and manually with <code>addAssayLink</code>.</p></li>
<li><p><em>One-to-one</em> Assay links produced by a processing function such as <code>logTransform</code> or with <code>addAssayLinkOneToOne</code>. These contain <code>"OneToOne"</code> in the <code>fcol</code> slot (isseu 42).</p></li>
<li><p>There will be a need for an assay link stemming from combining assays (see above and issue 52).</p></li>
</ul>
</div>
<div id="joining-assays" class="section level1">
<h1 class="hasAnchor">
<a href="#joining-assays" class="anchor" aria-hidden="true"></a>Joining assays</h1>
<p>To <em>combine</em> assays, we also need 1. relaxed <code>MatchedAssayExperiment</code> constrains (see #46) 2. assay links with multiple parent assays (see #52)</p>
<p><code>combine,MSnSet,MSnSet</code> does two things, i.e. <code>rbind</code> and <code>cbind</code>. Here, we nedd (at least in a first instance) and have <code>cbind,SummarizedExperiment</code>.</p>
<ul>
<li>do we need some constrains requiering identical rownames? <code>cbind,SummarizedExperiment</code> uses the mcols to check whether rows match.</li>
<li>should unique rows in one assay get NAs in the other one? yes!</li>
</ul>
<p>We need a <strong>join</strong>-type of function, that adds NAs at the assay level. To do this, we need to have a union of features before rbinding the assays.</p>
<p>As for rowData, we want to</p>
<ul>
<li>keep the mcols that match exactly between assays (ex: PeptideSequence, ProteinAccession, …)</li>
<li>remove mcols that differ between assays (ex: PEP, qvalues, charge, rtime, …)</li>
</ul>
<p>The row data will be accessible through links between assays anyway.</p>
<p>Naming:</p>
<pre><code>joinAssays(QFeatures, c("pep_batch1", "pep_batch2", "pep_batch3"), name = "peptides")
joinAssays(QFeatures, c(1, 2, 3), name = "peptides")</code></pre>
<p>Algorithm: 1. Find which mcols to keep 2. Extend with rownames and NAs (depending on type of join) 3. Order assays 4. cbind assays (see <code>cbind,SummarizedExperiment</code>)</p>
<p>Do we want a public <em>join</em> for SummarizedExperiments? Discuss with SE maintainers.</p>
<p>Note: if we were to have assay from multiple fractions to be <em>rbind</em>ed, we could consider a <code>rbindAssays</code>, <code>mergeFractions</code>, <code>bindFractions</code>, …</p>
</div>


  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>

</div>



      <footer>
      <div class="copyright">
  <p><p>Developed by Laurent Gatto, Christophe Vanderaa.</p></p>
</div>

<div class="pkgdown">
  <p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p></p>
</div>

      </footer>
   </div>

  


  

  </body>
</html>


